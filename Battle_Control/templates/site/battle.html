<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora da Batalha</title>
    <link rel="stylesheet" href="{% static 'Battle_Control/css/battle.css' %}?v=2">
</head>
<body>
{% if personagens_por_tipo %}
<div class="personagens-container">
  <div class="aliados">
    <h3>Aliados</h3>
    {% if personagens_por_tipo.Aliado %}
    
      <div class="cards-container">  <!-- ADICIONE ESSA DIV AQUI -->
        {% for p in personagens_por_tipo.Aliado %}
          <div class="card">

            <p>
              <!--
                <strong>Turno:</strong> {{ p.turno }}
              <form method="post" style="display: inline;" class="turno-form" data-action="diminuir" data-id="{{ p.id }}">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <button type="submit" name="aumentar_turno">+</button>
              </form>

              <form method="post" style="display: inline;" class="turno-form" data-action="diminuir" data-id="{{ p.id }}">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <button type="submit" name="diminuir_turno">-</button>
              </form><br>-->

              <strong>{{ p.nome }} - Lv {{ p.level }}</strong><br><br>
              {% if p.imagem %}
                <img src="{{ p.imagem.url }}" width="100" class="imagem-personagem">
              {% else %}
                <em>Sem imagem</em>
              {% endif %}<br><br>
              <strong>
                Vida atual: <span id="vida-{{ p.id }}">{{ p.vida|floatformat:"-1" }}</span> (<span id="barreira-{{ p.id }}">{{ p.barreira_magica }}</span>)<br>
                Defesa: {{ p.defesa_total|floatformat:"-1" }} ({{ p.armadura|floatformat:"-1" }})<br>
                ResistÃªncia: {{ p.resistencia|floatformat:"-1" }}<br>
                ForÃ§a: {{ p.forÃ§a|floatformat:"-1" }}<br>
                {% if p.magia %}
                  Magia: {{ p.magia|floatformat:"-1" }}<br>
                {% endif %}
                {% if p.mana %}
                Mana: {{ p.mana|floatformat:"-1" }}<br>
                {% endif %}
                {% if p.agiliade %}
                Agilidade: {{ p.agilidade|floatformat:"-1" }}<br>
                {% endif %}
              </strong>
              <!----------------------------- Causar Dano ----------------------------->
              <form class="form-aplicar-dano">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <input class="dano" type="number" name="dano" placeholder="Dano" step="0.1" required>
                <label><input class="checkbox" type="checkbox" name="critico"> ðŸ’¥</label>
                <button type="submit">Atacar</button>
              </form>
              <div class="resposta-dano" data-id="{{ p.id }}"></div>
              <!----------------------------- Curar ----------------------------->
              <form class="form-aplicar-cura">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <input class="dano" type="number" name="cura" placeholder="Cura" step="0.1">
                <label><input class="checkbox" type="checkbox" name="critico"> ðŸ’¥</label>
                <button type="submit">Curar</button>
              </form>
              <!----------------------------- Usar Item ----------------------------->
              {% for inv in p.inventario_set.all %}
                {% if inv.item.tipo == 'poÃ§Ã£o' %}
                    <form method="post" style="margin-top: 0.5rem;">
                        {% csrf_token %}
                        <input type="hidden" name="usar_item" value="1">
                        <input type="hidden" name="personagem_id" value="{{ p.id }}">
                        <input type="hidden" name="item_id" value="{{ inv.item.id }}">
                        <button type="submit">
                            Usar {{ inv.item.nome }} (x{{ inv.quantidade }})
                        </button>
                    </form>
                {% endif %}
              {% endfor %}
              <!----------------------------- Itens Usados ----------------------------->
              {% for item_aplicado in p.itens_aplicados.all %}
                {% if item_aplicado.ativo %}
                  <li>
                    ðŸŒ€ {{ item_aplicado.item.nome }}
                    <form method="post" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="remover_item_aplicado_id" value="{{ item_aplicado.id }}">
                      <button type="submit">Remover</button>
                    </form>
                  </li>
                {% endif %}
              {% endfor %}

              <!----------------------------- Causar Efeito ----------------------------->
              <form id="form-aplicar-efeito-{{ p.id }}" class="form-aplicar-efeito" method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                    {% for efeito in buffs %}
                        <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                    {% endfor %}
                </select>
                <button type="submit" onclick="aplicarEfeito('{{ p.id }}')">Aplicar Buff</button>
              </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                  {% for efeito in debuffs %}
                    <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Aplicar Debuff</button>
              </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                  {% for efeito in habilidades %}
                    <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Aplicar Efeito</button>
              </form>

              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="remover_id" value="{{ p.id }}">
                <button type="submit" name="remover_personagem">Remover</button>
              </form>
            </p>
            <!-----------------------------  ---------------------------
            {% with dano_bonus=0 %}
              {% for efeito_aplicado in p.efeitos_aplicados.all %}
                {% if efeito_aplicado.ativo %}
                  {% with dano_bonus=dano_bonus|add:efeito_aplicado.efeito.modificador_dano %}
                  <p>BÃ´nus de Dano Total: {{ dano_bonus }}</p>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            {% endwith %}
            -->
            
            <!----------------------------- Efeitos Aplicados ----------------------------->
            {% for efeito_aplicado in p.efeitos_aplicados.all %}
                  {% if efeito_aplicado.ativo %}
                    <br>
                      {% if efeito_aplicado.efeito.reversivel %}
                        <span style="color: green;">ðŸŒ€</span>
                      {% else %}
                        <span style="color: red;">â›”</span>
                      {% endif %}
                      {{ efeito_aplicado.efeito.nome }}
              
                      <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="remover_efeito_id" value="{{ efeito_aplicado.id }}">
                        <button type="submit">Remover</button>
                      </form>
                  {% endif %}
            <!----------------------------- Final do For ----------------------------->
            {% endfor %}
          </div>          
        {% endfor %}  
      </div>
    {% else %}
      <p>Nenhum aliado encontrado.</p>
    {% endif %}
  </div>


  <div class="inimigos">
    <h3>Inimigos</h3>
    {% if personagens_por_tipo.Aliado %}
    
      <div class="cards-container">  <!-- ADICIONE ESSA DIV AQUI -->
        {% for p in personagens_por_tipo.Inimigo %}
          <div class="card">

            <p>
              <!--
                <strong>Turno:</strong> {{ p.turno }}
              <form method="post" style="display: inline;" class="turno-form" data-action="diminuir" data-id="{{ p.id }}">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <button type="submit" name="aumentar_turno">+</button>
              </form>

              <form method="post" style="display: inline;" class="turno-form" data-action="diminuir" data-id="{{ p.id }}">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <button type="submit" name="diminuir_turno">-</button>
              </form><br>-->

              <strong>{{ p.nome }} - Lv {{ p.level }}</strong><br><br>
              {% if p.imagem %}
                <img src="{{ p.imagem.url }}" width="100" class="imagem-personagem">
              {% else %}
                <em>Sem imagem</em>
              {% endif %}<br><br>
              <strong>
                Vida atual: <span id="vida-{{ p.id }}">{{ p.vida|floatformat:"-2" }}</span> (<span id="barreira-{{ p.id }}">{{ p.barreira_magica }}</span>)<br>
                Defesa: {{ p.defesa_total|floatformat:"-2" }} ({{ p.armadura|floatformat:"-2" }})<br>
                ResistÃªncia: {{ p.resistencia|floatformat:"-2" }}<br>
                ForÃ§a: {{ p.forÃ§a|floatformat:"-2" }}<br>
                Magia: {{ p.magia|floatformat:"-2" }}<br>
                Mana: {{ p.mana|floatformat:"-2" }}<br>
                Agilidade: {{ p.agilidade|floatformat:"-2" }}<br>
                Sorte: {{ p.sorte|floatformat:"-2" }}<br>
              </strong>
              <!----------------------------- Causar Dano ----------------------------->
              <form class="form-aplicar-dano">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <input class="dano" type="number" name="dano" placeholder="Dano" step="0.1" required>
                <label><input class="checkbox" type="checkbox" name="critico"> ðŸ’¥</label>
                <button type="submit">Atacar</button>
              </form>
              <div class="resposta-dano" data-id="{{ p.id }}"></div>
              <!----------------------------- Curar ----------------------------->
              <form class="form-aplicar-cura">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <input class="dano" type="number" name="cura" placeholder="Cura" step="0.1">
                <label><input class="checkbox" type="checkbox" name="critico"> ðŸ’¥</label>
                <button type="submit">Curar</button>
              </form>
              <!----------------------------- Usar Item ----------------------------->
              {% for inv in p.inventario_set.all %}
                {% if inv.item.tipo == 'poÃ§Ã£o' %}
                    <form method="post" style="margin-top: 0.5rem;">
                        {% csrf_token %}
                        <input type="hidden" name="usar_item" value="1">
                        <input type="hidden" name="personagem_id" value="{{ p.id }}">
                        <input type="hidden" name="item_id" value="{{ inv.item.id }}">
                        <button type="submit">
                            Usar {{ inv.item.nome }} (x{{ inv.quantidade }})
                        </button>
                    </form>
                {% endif %}
              {% endfor %}
              <!----------------------------- Itens Usados ----------------------------->
              {% for item_aplicado in p.itens_aplicados.all %}
                {% if item_aplicado.ativo %}
                  <li>
                    ðŸŒ€ {{ item_aplicado.item.nome }}
                    <form method="post" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="remover_item_aplicado_id" value="{{ item_aplicado.id }}">
                      <button type="submit">Remover</button>
                    </form>
                  </li>
                {% endif %}
              {% endfor %}

              <!----------------------------- Causar Efeito ----------------------------->
              <form id="form-aplicar-efeito-{{ p.id }}" class="form-aplicar-efeito" method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                    {% for efeito in buffs %}
                        <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                    {% endfor %}
                </select>
                <button type="submit" onclick="aplicarEfeito('{{ p.id }}')">Aplicar Buff</button>
            </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                  {% for efeito in debuffs %}
                    <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Aplicar Debuff</button>
              </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="personagem_id" value="{{ p.id }}">
                <select name="efeito_id">
                  {% for efeito in habilidades %}
                    <option value="{{ efeito.id }}">{{ efeito.nome }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Aplicar Efeito</button>
              </form>

              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="remover_id" value="{{ p.id }}">
                <button type="submit" name="remover_personagem">Remover</button>
              </form>
            </p>
            <!----------------------------- Causar Dano ----------------------------
            {% with dano_bonus=0 %}
              {% for efeito_aplicado in p.efeitos_aplicados.all %}
                {% if efeito_aplicado.ativo %}
                  {% with dano_bonus=dano_bonus|add:efeito_aplicado.efeito.modificador_dano %}
                  <p>BÃ´nus de Dano Total: {{ dano_bonus }}</p>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            {% endwith %}
             --->
            <!----------------------------- Efeitos Aplicados ----------------------------->
            {% for efeito_aplicado in p.efeitos_aplicados.all %}
                  {% if efeito_aplicado.ativo %}
                    <br>
                      {% if efeito_aplicado.efeito.reversivel %}
                        <span style="color: green;">ðŸŒ€</span>
                      {% else %}
                        <span style="color: red;">â›”</span>
                      {% endif %}
                      {{ efeito_aplicado.efeito.nome }}
              
                      <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="remover_efeito_id" value="{{ efeito_aplicado.id }}">
                        <button type="submit">Remover</button>
                      </form>
                  {% endif %}
            <!----------------------------- Final do For ----------------------------->
            {% endfor %}
          </div>          
        {% endfor %}  
      </div>
    {% else %}
      <p>Nenhum Inimigo encontrado.</p>
    {% endif %}
  </div>

{% else %}
  <p>Nenhum personagem adicionado ainda.</p>
{% endif %}
</div>

<!----------------------------- Menu Bar ----------------------------->
  <hr>  
  <form method="post">
      {% csrf_token %}
      <label for="personagem">Escolha um personagem:</label>
      <select name="personagem" id="personagem">
        {% for personagem in personagens %}
          <option value="{{ personagem.id }}">{{ personagem.nome }} ({{ personagem.tipo }})</option>
        {% endfor %}
      </select>
      <button class="link" type="submit">Adicionar</button>
    </form>
    
    <form method="post" style="margin-top: 1rem;">
      {% csrf_token %}
      <button class="link" name="limpar" value="1" type="submit">Limpar seleÃ§Ã£o</button>
    </form>
    <a class="link" href="{% url 'rpg:adventure' %}">Planejar Itens</a>
  
<a class='link'href="{% url 'rpg:index' %}">Voltar</a>

    
<script>
  document.querySelectorAll('.form-aplicar-dano').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();

      // Pega valores direto dos inputs
      const personagemId = form.querySelector('input[name="personagem_id"]').value;
      const dano = form.querySelector('input[name="dano"]').value;
      const critico = form.querySelector('input[name="critico"]').checked ? 'on' : '';

      // Monta corpo da requisiÃ§Ã£o
      const body = new URLSearchParams({
        personagem_id: personagemId,
        dano: dano,
        critico: critico
      });

      const response = await fetch("{% url 'rpg:aplicar_dano' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: body.toString()
      });

      const data = await response.json();
          // Atualizar a vida e barreira no HTML
      const vidaSpan = document.querySelector(`#vida-${personagemId}`);
      const barreiraSpan = document.querySelector(`#barreira-${personagemId}`);
      
      if (vidaSpan) vidaSpan.textContent = data.vida_atual;
      if (barreiraSpan) barreiraSpan.textContent = data.barreira;

      // Aqui vocÃª pode atualizar o DOM com data.mensagem ou recarregar sÃ³ a parte da vida, etc.
      console.log(data);
    });
  });
  
  document.querySelectorAll('.form-aplicar-cura').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();

      const personagemId = form.querySelector('input[name="personagem_id"]').value;
      const cura = form.querySelector('input[name="cura"]').value;
      const critico = form.querySelector('input[name="critico"]').checked ? 'on' : '';

      const body = new URLSearchParams({
        personagem_id: personagemId,
        cura: cura,
        critico: critico
      });

      const response = await fetch("{% url 'rpg:aplicar_cura' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: body.toString()
      });

      const data = await response.json();

      const vidaSpan = document.querySelector(`#vida-${personagemId}`);
      if (vidaSpan) vidaSpan.textContent = data.vida_atual;

      console.log(data.mensagem);
    });
  });
</script>
</body>
<script>
    function adicionarSelect() {
      const container = document.getElementById('select-container');
      const novoSelect = container.children[0].cloneNode(true);
      container.appendChild(novoSelect);
    }
</script>
</html>